name: pkgdown

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: pkgdown-${{ github.ref }}
  cancel-in-progress: true

jobs:
  pkgdown:
    runs-on: ubuntu-latest

    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - uses: actions/checkout@v4

      - uses: r-lib/actions/setup-pandoc@v2

      # Quarto (per futuri .qmd nelle vignette/articoli)
      - uses: r-lib/actions/setup-quarto@v2
        with:
          version: "latest"

      - uses: r-lib/actions/setup-r@v2
        with:
          use-public-rspm: true

      # TinyTeX per compilare le vignette Sweave in PDF
      - uses: r-lib/actions/setup-tinytex@v2

      # Pacchetti LaTeX aggiuntivi necessari ai tuoi .Rnw/.bib/.sty
      - name: Install LaTeX extras (tlmgr via R)
        shell: Rscript {0}
        run: |
          pkgs <- c(
            "ae","inconsolata","upquote","courier","fancyvrb","framed","titling","booktabs",
            "geometry","hyperref","url","xcolor","microtype","graphicx","graphics",
            "grfext","thumbpdf","float","caption","subcaption","babel-english",
            "amsmath","amssymb","mathtools","siunitx","etoolbox","natbib","biblatex",
            "csquotes","ulem","parskip","titlesec","wrapfig","longtable",
            "makecell","multirow","colortbl","pgf","tikz","xkeyval","changepage"
          )
          if (Sys.which("tlmgr") != "") {
            tinytex::tlmgr_install(pkgs, .quiet = TRUE)
          }

      # Dipendenze R, inclusi pkgdown e il pacchetto locale
      - uses: r-lib/actions/setup-r-dependencies@v2
        with:
          extra-packages: any::pkgdown, local::.
          needs: website

      # (Opzionale) tools per comprimere PDF (di solito giÃ  presenti)
      - name: Ensure PDF tools (Ubuntu)
        if: runner.os == 'Linux'
        run: sudo apt-get update && sudo apt-get install -y ghostscript qpdf

      # (1) Compila le VIGNETTE in PDF (inst/doc) e copia i PDF sotto docs/articles/
      - name: Build vignettes (PDF) and stage for pkgdown
        shell: Rscript {0}
        run: |
          # Compila le vignette in PDF (inst/doc)
          tools::buildVignettes(dir = ".", tangle = FALSE)
          # Comprime i PDF (se disponibili)
          if (dir.exists("inst/doc")) try(tools::compactPDF("inst/doc", qpdf = "qpdf"), silent = TRUE)
          # Crea la cartella di destinazione per gli articoli pkgdown
          dir.create("docs/articles", recursive = TRUE, showWarnings = FALSE)
          # Copia i PDF delle vignette in docs/articles per il download dal sito
          if (dir.exists("inst/doc")) {
            pdfs <- list.files("inst/doc", pattern = "\\.pdf$", full.names = TRUE)
            file.copy(from = pdfs, to = file.path("docs/articles", basename(pdfs)), overwrite = TRUE)
          }

      # (2) Costruisci il sito pkgdown (HTML) in docs/
      - name: Build site
        run: pkgdown::build_site_github_pages(new_process = FALSE, install = FALSE)
        shell: Rscript {0}

      # Deploy a gh-pages
      - name: Deploy to GitHub pages ðŸš€
        if: github.event_name != 'pull_request'
        uses: JamesIves/github-pages-deploy-action@v4.5.0
        with:
          clean: false
          branch: gh-pages
          folder: docs

